<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-outline-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .btn-outline-purple:hover {
            opacity: 0.8;
            color: white;
        }

        /* Console Log Styles */
        #consoleLog {
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
        }

        /* Positions Table Styles */
        #positionsTable .table {
            margin-bottom: 0;
        }

        .table-responsive {
            overflow-x: auto;
        }

        /* Strategy Configuration Styles */
        .strategy-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .strategy-table th, .strategy-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .strategy-table th {
            background-color: #f2f2f2;
        }

        /* Chart Container Styles */
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Environment Switch Styles */
        .environment-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .environment-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .environment-info {
            text-align: center;
        }

        .environment-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .environment-badge.testnet {
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #1565c0;
        }

        .environment-badge.mainnet {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #c62828;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 200px;
            height: 50px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1565c0;
            transition: .4s;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-weight: bold;
            font-size: 12px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 40px;
            width: 90px;
            left: 5px;
            bottom: 5px;
            background: white;
            transition: .4s;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background: #c62828;
        }

        input:checked + .slider:before {
            transform: translateX(90px);
        }

        .slider-text {
            z-index: 1;
            color: white;
            position: relative;
        }

        .slider-text.testnet {
            margin-left: 10px;
        }

        .slider-text.mainnet {
            margin-right: 10px;
        }

        input:not(:checked) + .slider .testnet {
            color: #1565c0;
        }

        input:checked + .slider .mainnet {
            color: #c62828;
        }

        .environment-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-robot"></i> Trading Bot Dashboard
            </span>
            <div class="d-flex">
                <span class="badge bg-{{ 'success' if status.running else 'danger' }} me-2">
                    {{ 'RUNNING' if status.running else 'STOPPED' }}
                </span>
                <button id="botToggle" class="btn btn-{{ 'danger' if status.running else 'success' }} btn-sm">
                    {{ 'Stop Bot' if status.running else 'Start Bot' }}
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Bot Status Card -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-info-circle"></i> Bot Status</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Status:</strong> <span id="botStatus" class="badge bg-{{ 'success' if status.running else 'danger' }}">{{ 'RUNNING' if status.running else 'STOPPED' }}</span></p>
                        <p><strong>Balance:</strong> $<span id="balance">{{ "%.2f"|format(balance) }}</span> USDT</p>
                        <p><strong>Active Positions:</strong> <span id="activePositions">{{ status.active_positions }}</span></p>
                        <p><strong>Active Strategies:</strong> {{ status.strategies|length }}</p>
                        <button class="btn btn-info btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="showStrategiesInfo()">
                                    <i class="fas fa-cog"></i><br>View Strategies
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="refreshData()">
                                    <i class="fas fa-chart-line"></i><br>Refresh Data
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="clearConsoleLog()">
                                    <i class="fas fa-trash"></i><br>Clear Console
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-dark w-100 mb-2" onclick="showConsoleInfo()">
                                    <i class="fas fa-terminal"></i><br>Console Info
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="editStrategy()">
                                    <i class="fas fa-edit"></i><br>Edit Strategy
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100 mb-2" onclick="showAnomalies()">
                                    <i class="fas fa-exclamation-triangle"></i><br>Anomalies
                                </button>
                            </div>
                            <div class="col-md-2">
                                <a href="/ml_reports" target="_blank" class="btn btn-outline-purple w-100 mb-2" style="text-decoration: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <i class="fas fa-brain"></i><br>ML Reports
                                </a>
                            </div>
                            <div class="col-md-2">
                                <a href="/trades_database" target="_blank" class="btn btn-outline-info w-100 mb-2" style="text-decoration: none;">
                                    <i class="fas fa-database"></i><br>Trades Database
                                </a>
                            </div></div>
                        <div class="row">
                        </div>
                    </div>
                </div>

                <!-- Environment Switch -->
                <div class="environment-section">
                    <h3>Trading Environment</h3>
                    <div class="environment-controls">
                        <div class="environment-info">
                            <span id="currentEnvironment" class="environment-badge">Loading...</span>
                        </div>
                        <div class="environment-switch">
                            <label class="switch">
                                <input type="checkbox" id="environmentToggle">
                                <span class="slider">
                                    <span class="slider-text testnet">TESTNET</span>
                                    <span class="slider-text mainnet">MAINNET</span>
                                </span>
                            </label>
                        </div>
                        <div class="environment-warning" id="environmentWarning" style="display: none;">
                            <p>⚠️ Bot restart required for environment change to take effect</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Positions and Console Log -->
        <div class="row mt-4">
            <!-- Active Positions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-coins"></i> Active Positions</h5>
                    </div>
                    <div class="card-body">
                        <div id="positionsTable">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Symbol</th>
                                            <th>Side</th>
                                            <th>Entry Price</th>
                                            <th>Position (USDT)</th>
                                            <th>Current Price</th>
                                            <th>PnL (USDT)</th>
                                            <th>PnL (%)</th>
                                            <th>Current RSI</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positionsTableBody">
                                        <tr>
                                            <td colspan="9" class="text-muted text-center">Loading positions...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Console Log -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-terminal"></i> Live Console Log</h5>
                        <div class="float-end">
                            <button class="btn btn-sm btn-outline-light" onclick="clearConsoleLog()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="toggleAutoScroll()" id="autoScrollBtn">
                                <i class="fas fa-arrows-alt-v"></i> Auto-scroll: ON
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="consoleLog" style="height: 400px; overflow-y: auto; background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px;">
                            <div class="text-muted">Waiting for console output...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Configuration -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-cogs"></i> Strategy Configuration</h5>
                        <div class="float-end">
                            <button class="btn btn-sm btn-outline-light" onclick="addNewStrategy()">
                                <i class="fas fa-plus"></i> Add Strategy
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Margin (USDT)</th>
                                        <th>Leverage</th>
                                        <th>Timeframe</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for strategy_name, config in strategies.items() %}
                                    <tr>
                                        <td>{{ strategy_name.upper() }}</td>
                                        <td>{{ config.symbol }}</td>
                                        <td>${{ config.margin }}</td>
                                        <td>{{ config.leverage }}x</td>
                                        <td>{{ config.timeframe }}</td>
                                        <td><span class="badge bg-success">Active</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editStrategyConfig('{{ strategy_name }}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="disableStrategy('{{ strategy_name }}')">
                                                <i class="fas fa-pause"></i> Disable
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Edit Modal -->
    <div class="modal fade" id="strategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Strategy Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyForm">
                        <input type="hidden" id="strategyName" />
                        <div class="mb-3">
                            <label for="strategySymbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="strategySymbol" placeholder="e.g., BTCUSDT">
                        </div>
                        <div class="mb-3">
                            <label for="strategyMargin" class="form-label">Margin (USDT)</label>
                            <input type="number" class="form-control" id="strategyMargin" step="0.1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="strategyLeverage" class="form-label">Leverage</label>
                            <input type="number" class="form-control" id="strategyLeverage" min="1" max="125">
                        </div>
                         <div class="mb-3">
                            <label for="strategyDecimals" class="form-label">Decimal Precision</label>
                            <input type="number" class="form-control" id="strategyDecimals" min="0" max="8" value="2">
                        </div>
                        <div class="mb-3">
                            <label for="strategyTimeframe" class="form-label">Timeframe</label>
                            <select class="form-control" id="strategyTimeframe">
                                <option value="1m">1 minute</option>
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="4h">4 hours</option>
                                <option value="1d">1 day</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="strategyMaxLoss" class="form-label">Max Loss % (of margin)</label>
                            <input type="number" class="form-control" id="strategyMaxLoss" step="0.1" min="1" max="50" placeholder="e.g., 10">
                        </div>
                        <div class="mb-3">
                            <label for="assessmentInterval" class="form-label">Market Assessment Interval (seconds)</label>
                            <input type="number" class="form-control" id="assessmentInterval" step="1" min="5" max="300" placeholder="e.g., 60">
                            <div class="form-text">How often the bot scans the market for entry signals (5-300 seconds)</div>
                        </div>
                        <div class="mb-3">
                            <label for="cooldownPeriod" class="form-label">Cooldown Period (seconds)</label>
                            <input type="number" class="form-control" id="cooldownPeriod" step="1" min="30" max="3600" placeholder="e.g., 300">
                            <div class="form-text">Time to wait before allowing another trade on the same symbol/strategy (30-3600 seconds)</div>
                        </div>

                        <!-- RSI Strategy Parameters (shown only for RSI strategies) -->
                        <div id="rsiParameters" style="display: none;">
                            <h6 class="text-primary mt-3">RSI Strategy Parameters</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label for="rsiLongEntry" class="form-label">RSI Long Entry</label>
                                    <input type="number" class="form-control" id="rsiLongEntry" min="10" max="50" placeholder="e.g., 40">
                                </div>
                                <div class="col-6">
                                    <label for="rsiLongExit" class="form-label">RSI Long Exit</label>
                                    <input type="number" class="form-control" id="rsiLongExit" min="50" max="90" placeholder="e.g., 70">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label for="rsiShortEntry" class="form-label">RSI Short Entry</label>
                                    <input type="number" class="form-control" id="rsiShortEntry" min="50" max="90" placeholder="e.g., 60">
                                </div>
                                <div class="col-6">
                                    <label for="rsiShortExit" class="form-label">RSI Short Exit</label>
                                    <input type="number" class="form-control" id="rsiShortExit" min="10" max="50" placeholder="e.g., 30">
                                </div>
                            </div>
                        </div>

                        <!-- MACD Strategy Parameters (shown only for MACD strategies) -->
                        <div id="macdParameters" style="display: none;">
                            <h6 class="text-primary mt-3">MACD Strategy Parameters</h6>
                            <div class="row">
                                <div class="col-4">
                                    <label for="macdFast" class="form-label">MACD Fast</label>
                                    <input type="number" class="form-control" id="macdFast" min="5" max="20" placeholder="e.g., 12">
                                </div>
                                <div class="col-4">
                                    <label for="macdSlow" class="form-label">MACD Slow</label>
                                    <input type="number" class="form-control" id="macdSlow" min="20" max="40" placeholder="e.g., 26">
                                </div>
                                <div class="col-4">
                                    <label for="macdSignal" class="form-label">MACD Signal</label>
                                    <input type="number" class="form-control" id="macdSignal" min="5" max="15" placeholder="e.g., 9">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label for="macdMinHistogram" class="form-label">Min Histogram Threshold</label>
                                    <input type="number" class="form-control" id="macdMinHistogram" step="0.0001" min="0.0001" max="0.01" placeholder="e.g., 0.0001">
                                </div>
                                <div class="col-6">
                                    <label for="macdMinDistance" class="form-label">Min Distance Threshold (%)</label>
                                    <input type="number" class="form-control" id="macdMinDistance" step="0.001" min="0.001" max="5" placeholder="e.g., 0.005">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label for="macdConfirmationCandles" class="form-label">Confirmation Candles</label>
                                    <input type="number" class="form-control" id="macdConfirmationCandles" min="1" max="5" placeholder="e.g., 2">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStrategyConfig()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for auto-scroll
        let autoScroll = true;
        let consoleLogBuffer = [];

        // Bot control functions
        document.getElementById('botToggle').addEventListener('click', function() {
            const isRunning = this.textContent.includes('Stop');
            const endpoint = isRunning ? '/api/bot/stop' : '/api/bot/start';

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Connection error');
            });
        });

        // Refresh data
        function refreshData() {
            location.reload();
        }

        // Show strategies info
        function showStrategiesInfo() {
            fetch('/api/strategies')
                .then(response => response.json())
                .then(data => {
                    let info = 'Current Strategies:\n\n';
                    for (const strategyName in data) {
                        const config = data[strategyName];
                        info += strategyName.toUpperCase() + ':\n';
                        info += '  Symbol: ' + config.symbol + '\n';
                        info += '  Margin: $' + config.margin + '\n';
                        info += '  Leverage: ' + config.leverage + 'x\n';
                        info += '  Timeframe: ' + config.timeframe + '\n\n';
                    }
                    alert(info);
                })
                .catch(error => {
                    alert('Error loading strategies: ' + error);
                });
        }

        // Show console info
        function showConsoleInfo() {
            alert('Console shows real-time bot activity:\n\n' +
                  '• Green messages: Successful operations\n' +
                  '• Red messages: Errors or warnings\n' +
                  '• Blue messages: Information\n' +
                  '• Yellow messages: Market analysis\n\n' +
                  'Auto-scroll keeps the latest messages visible.');
        }

        // Edit strategy function
        function editStrategy() {
            alert('Select a strategy from the table below to edit its configuration.');
        }

        // Show anomalies function
        function showAnomalies() {
            alert('Anomaly detection monitors for orphan trades and ghost positions.\n\n' +
                  'Check the console log for anomaly notifications.');
        }

        // Strategy management functions
        function editStrategyConfig(strategyName) {
            fetch('/api/strategies')
                .then(response => response.json())
                .then(data => {
                    const config = data[strategyName];
                    if (config) {
                        // Basic parameters
                        document.getElementById('strategyName').value = strategyName;
                        document.getElementById('strategySymbol').value = config.symbol || '';
                        document.getElementById('strategyMargin').value = config.margin || '';
                        document.getElementById('strategyLeverage').value = config.leverage || '';
                        document.getElementById('strategyDecimals').value = config.decimals || 2;
                        document.getElementById('strategyTimeframe').value = config.timeframe || '';
                        document.getElementById('strategyMaxLoss').value = config.max_loss_pct || 10;
                        document.getElementById('assessmentInterval').value = config.assessment_interval || 300;
                        document.getElementById('cooldownPeriod').value = config.cooldown_period || 300;

                        // Hide all strategy-specific sections first
                        document.getElementById('rsiParameters').style.display = 'none';
                        document.getElementById('macdParameters').style.display = 'none';

                        // Show and populate RSI parameters if it's an RSI strategy
                        if (strategyName.toLowerCase().includes('rsi')) {
                            document.getElementById('rsiParameters').style.display = 'block';
                            document.getElementById('rsiLongEntry').value = config.rsi_long_entry || 40;
                            document.getElementById('rsiLongExit').value = config.rsi_long_exit || 70;
                            document.getElementById('rsiShortEntry').value = config.rsi_short_entry || 60;
                            document.getElementById('rsiShortExit').value = config.rsi_short_exit || 30;
                        }

                        // Show and populate MACD parameters if it's a MACD strategy
                        if (strategyName.toLowerCase().includes('macd')) {
                            document.getElementById('macdParameters').style.display = 'block';
                            document.getElementById('macdFast').value = config.macd_fast || 12;
                            document.getElementById('macdSlow').value = config.macd_slow || 26;
                            document.getElementById('macdSignal').value = config.macd_signal || 9;
                            document.getElementById('macdMinHistogram').value = config.min_histogram_threshold || 0.0001;
                            document.getElementById('macdMinDistance').value = config.min_distance_threshold || 0.005;
                            document.getElementById('macdConfirmationCandles').value = config.confirmation_candles || 2;
                        }

                        const modal = new bootstrap.Modal(document.getElementById('strategyModal'));
                        modal.show();
                    }
                })
                .catch(error => {
                    alert('Error loading strategy config: ' + error);
                });
        }

        function saveStrategyConfig() {
            const strategyName = document.getElementById('strategyName').value;
            const config = {
                symbol: document.getElementById('strategySymbol').value,
                margin: parseFloat(document.getElementById('strategyMargin').value) || 50,
                leverage: parseInt(document.getElementById('strategyLeverage').value) || 5,
                decimals: parseInt(document.getElementById('strategyDecimals').value) || 2,
                timeframe: document.getElementById('strategyTimeframe').value || '15m',
                max_loss_pct: parseFloat(document.getElementById('strategyMaxLoss').value) || 10,
                assessment_interval: parseInt(document.getElementById('assessmentInterval').value) || 300,
                cooldown_period: parseInt(document.getElementById('cooldownPeriod').value) || 300
            };

            // Add RSI-specific parameters if RSI strategy
            if (strategyName.toLowerCase().includes('rsi')) {
                config.rsi_long_entry = parseInt(document.getElementById('rsiLongEntry').value) || 40;
                config.rsi_long_exit = parseInt(document.getElementById('rsiLongExit').value) || 70;
                config.rsi_short_entry = parseInt(document.getElementById('rsiShortEntry').value) || 60;
                config.rsi_short_exit = parseInt(document.getElementById('rsiShortExit').value) || 30;
            }

            // Add MACD-specific parameters if MACD strategy
            if (strategyName.toLowerCase().includes('macd')) {
                config.macd_fast = parseInt(document.getElementById('macdFast').value) || 12;
                config.macd_slow = parseInt(document.getElementById('macdSlow').value) || 26;
                config.macd_signal = parseInt(document.getElementById('macdSignal').value) || 9;
                config.min_histogram_threshold = parseFloat(document.getElementById('macdMinHistogram').value) || 0.0001;
                config.min_distance_threshold = parseFloat(document.getElementById('macdMinDistance').value) || 0.005;
                config.confirmation_candles = parseInt(document.getElementById('macdConfirmationCandles').value) || 2;
            }

            // Disable the save button to prevent double-submission
            const saveButton = document.querySelector('#strategyModal .btn-primary');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            fetch('/api/strategies/' + strategyName, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Strategy updated successfully! Changes have been saved to configuration files.');
                    bootstrap.Modal.getInstance(document.getElementById('strategyModal')).hide();

                    // Wait a moment for the save to complete, then reload
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('Error updating strategy: ' + data.message);
                    // Re-enable the save button on error
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            })
            .catch(error => {
                alert('Error saving strategy: ' + error);
                // Re-enable the save button on error
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            });
        }

        function disableStrategy(strategyName) {
            if (confirm('Are you sure you want to disable the ' + strategyName + ' strategy?')) {
                alert('Strategy disable functionality will be implemented in a future update.');
            }
        }

        // Add new strategy function
        function addNewStrategy() {
            // Create a simple modal dialog for new strategy
            const strategyName = prompt('Enter new strategy name (must contain "rsi" or "macd"):');

            if (!strategyName) return;

            // Validate strategy name
            if (!strategyName.toLowerCase().includes('rsi') && !strategyName.toLowerCase().includes('macd')) {
                alert('Strategy name must contain "rsi" or "macd" to determine indicator type');
                return;
            }

            const symbol = prompt('Enter symbol (e.g., BTCUSDT):', 'BTCUSDT');
            if (!symbol) return;

            const margin = prompt('Enter margin amount (USDT):', '50');
            if (!margin) return;

            const leverage = prompt('Enter leverage (1-125):', '5');
            if (!leverage) return;

            const newStrategy = {
                name: strategyName,
                symbol: symbol.toUpperCase(),
                margin: parseFloat(margin),
                leverage: parseInt(leverage),
                timeframe: '15m',
                max_loss_pct: 10
            };

            // Add strategy-specific defaults
            if (strategyName.toLowerCase().includes('rsi')) {
                newStrategy.rsi_long_entry = 40;
                newStrategy.rsi_long_exit = 70;
                newStrategy.rsi_short_entry = 60;
                newStrategy.rsi_short_exit = 30;
            } else if (strategyName.toLowerCase().includes('macd')) {
                newStrategy.macd_fast = 12;
                newStrategy.macd_slow = 26;
                newStrategy.macd_signal = 9;
                newStrategy.min_histogram_threshold = 0.0001;
                newStrategy.min_distance_threshold = 0.005;
                newStrategy.confirmation_candles = 2;
            }

            // Send to backend
            fetch('/api/strategies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newStrategy)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Strategy created successfully! ' + data.message);
                    location.reload(); // Refresh to show new strategy
                } else {
                    alert('Error creating strategy: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error creating strategy: ' + error);
            });
        }

        // Update positions table
        function updatePositionsTable() {
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.positions) {
                        updatePositionsDisplay(data.positions);
                    } else {
                        document.getElementById('positionsTableBody').innerHTML = 
                            '<tr><td colspan="9" class="text-muted text-center">No active positions</td></tr>';
                    }
                })
                .catch(error => {
                    document.getElementById('positionsTableBody').innerHTML = 
                        '<tr><td colspan="9" class="text-danger text-center">Failed to load positions</td></tr>';
                });
        }

        function updatePositionsDisplay(positions) {
            if (positions.length === 0) {
                document.getElementById('positionsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-muted text-center">No active positions</td></tr>';
                return;
            }

            let html = '';
            positions.forEach(function(position, index) {
                let pnlClass = position.pnl > 0 ? 'text-success' : 'text-danger';
                let sideClass = position.side === 'BUY' ? 'success' : 'danger';

                html += '<tr>';
                html += '<td>' + position.strategy.toUpperCase() + '</td>';
                html += '<td>' + position.symbol + '</td>';
                html += '<td><span class="badge bg-' + sideClass + '">' + position.side + '</span></td>';
                html += '<td>$' + position.entry_price.toFixed(1) + '</td>';
                html += '<td>$' + (position.position_value_usdt ? position.position_value_usdt.toFixed(2) : (position.entry_price * position.quantity).toFixed(2)) + '</td>';
                html += '<td>' + (position.current_price ? '$' + position.current_price.toFixed(1) : 'N/A') + '</td>';
                html += '<td class="' + pnlClass + '">$' + position.pnl.toFixed(2) + '</td>';
                html += '<td class="' + pnlClass + '">' + (position.pnl_percent > 0 ? '+' : '') + position.pnl_percent.toFixed(2) + '%</td>';
                html += '<td><span id="rsi-' + index + '" class="badge bg-secondary">Loading...</span></td>';
                html += '</tr>';
            });
            document.getElementById('positionsTableBody').innerHTML = html;

            // Fetch RSI for each position
            positions.forEach(function(position, index) {
                fetchRSI(position.symbol, index);
            });
        }

        function fetchRSI(symbol, index) {
            fetch('/api/rsi/' + symbol)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let rsiValue = data.rsi;
                        let rsiClass = 'bg-secondary';

                        // Color code RSI values
                        if (rsiValue <= 30) {
                            rsiClass = 'bg-success'; // Oversold - green
                        } else if (rsiValue >= 70) {
                            rsiClass = 'bg-danger'; // Overbought - red
                        } else if (rsiValue <= 40) {
                            rsiClass = 'bg-info'; // Low - blue
                        } else if (rsiValue >= 60) {
                            rsiClass = 'bg-warning'; // High - yellow
                        }

                        const rsiElement = document.getElementById('rsi-' + index);
                        if (rsiElement) {
                            rsiElement.className = 'badge ' + rsiClass;
                            rsiElement.textContent = 'RSI: ' + rsiValue;
                        }
                    } else {
                        const rsiElement = document.getElementById('rsi-' + index);
                        if (rsiElement) {
                            rsiElement.className = 'badge bg-danger';
                            rsiElement.textContent = 'Error';
                        }
                    }
                })
                .catch(error => {
                    const rsiElement = document.getElementById('rsi-' + index);
                    if (rsiElement) {
                        rsiElement.className = 'badge bg-danger';
                        rsiElement.textContent = 'N/A';
                    }
                });
        }

        // Console log functions
        function fetchConsoleLog() {
            fetch('/api/console-log')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.logs) {
                        updateConsoleLog(data.logs);
                    }
                })
                .catch(error => {
                    console.error('Error fetching console log:', error.message || error.toString());
                    // Don't spam the console with errors, just show once
                    if (!window.consoleErrorShown) {
                        const consoleElement = document.getElementById('consoleLog');
                        if (consoleElement) {
                            consoleElement.innerHTML = '<div class="text-warning">Console log unavailable - bot may be stopped</div>';
                            window.consoleErrorShown = true;
                        }
                    }
                });
        }

        function updateConsoleLog(logs) {
            const consoleElement = document.getElementById('consoleLog');

            // Add new logs to buffer
            logs.forEach(function(log) {
                // Convert log to string if it's not already
                const logString = typeof log === 'string' ? log : JSON.stringify(log);

                if (!consoleLogBuffer.includes(logString)) {
                    consoleLogBuffer.push(logString);

                    // Create log element
                    const logElement = document.createElement('div');
                    logElement.style.marginBottom = '2px';
                    logElement.style.wordWrap = 'break-word';

                    // Color code different log types
                    if (logString.includes('ERROR') || logString.includes('❌')) {
                        logElement.style.color = '#ff6b6b';
                    } else if (logString.includes('WARNING') || logString.includes('⚠️')) {
                        logElement.style.color = '#feca57';
                    } else if (logString.includes('SUCCESS') || logString.includes('✅')) {
                        logElement.style.color = '#48dbfb';
                    } else if (logString.includes('INFO') || logString.includes('ℹ️')) {
                        logElement.style.color = '#0abde3';
                    } else {
                        logElement.style.color = '#ffffff';
                    }

                    logElement.textContent = logString;
                    consoleElement.appendChild(logElement);
                }
            });

            // Limit buffer size
            if (consoleLogBuffer.length > 1000) {
                consoleLogBuffer = consoleLogBuffer.slice(-500);
                // Clear and rebuild console
                consoleElement.innerHTML = '';
                consoleLogBuffer.forEach(function(log) {
                    const logElement = document.createElement('div');
                    logElement.textContent = log;
                    consoleElement.appendChild(logElement);
                });
            }

            // Auto-scroll to bottom if enabled
            if (autoScroll) {
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
        }

        function clearConsoleLog() {
            document.getElementById('consoleLog').innerHTML = '<div class="text-muted">Console cleared...</div>';
            consoleLogBuffer = [];
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.innerHTML = '<i class="fas fa-arrows-alt-v"></i> Auto-scroll: ' + (autoScroll ? 'ON' : 'OFF');
            btn.className = autoScroll ? 'btn btn-sm btn-outline-light' : 'btn btn-sm btn-outline-secondary';
        }

        // Update dashboard data
        function updateDashboard() {
            updateBotStatus();
            updateBalance();
            updatePositions();
            updateConsoleLog();
            updateEnvironment();
        }

         // Update environment status
        function updateEnvironment() {
            fetch('/api/trading/environment')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const env = data.environment;
                        const badge = document.getElementById('currentEnvironment');
                        const toggle = document.getElementById('environmentToggle');

                        if (env.is_testnet) {
                            badge.textContent = 'FUTURES TESTNET';
                            badge.className = 'environment-badge testnet';
                            toggle.checked = false;
                        } else {
                            badge.textContent = 'FUTURES MAINNET';
                            badge.className = 'environment-badge mainnet';
                            toggle.checked = true;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating environment:', error);
                    document.getElementById('currentEnvironment').textContent = 'Unknown';
                });
        }

        // Toggle environment
        function toggleEnvironment() {
            const toggle = document.getElementById('environmentToggle');
            const isMainnet = toggle.checked;

            if (isMainnet) {
                const confirmed = confirm(
                    '⚠️ WARNING: You are switching to MAINNET (REAL MONEY)!\n\n' +
                    'This will use real funds for trading. Are you sure?'
                );
                if (!confirmed) {
                    toggle.checked = false;
                    return;
                }
            }

            fetch('/api/trading/environment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    is_testnet: !isMainnet
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateEnvironment();

                    if (data.environment.restart_required) {
                        document.getElementById('environmentWarning').style.display = 'block';
                    } else {
                        document.getElementById('environmentWarning').style.display = 'none';
                    }

                    alert(data.message);
                } else {
                    alert('Failed to update environment: ' + data.message);
                    updateEnvironment(); // Reset toggle position
                }
            })
            .catch(error => {
                console.error('Error toggling environment:', error);
                alert('Error updating environment');
                updateEnvironment(); // Reset toggle position
            });
        }

        // Auto-refresh every 5 seconds for positions and every 2 seconds for console
        setInterval(function() {
            updatePositionsTable();

            // Update bot status with better error handling
            fetch('/api/bot/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const statusElement = document.getElementById('botStatus');
                    const activePositionsElement = document.getElementById('activePositions');

                    if (statusElement && data) {
                        const isRunning = data.running || data.status === 'running';
                        statusElement.textContent = isRunning ? 'RUNNING' : 'STOPPED';
                        statusElement.className = 'badge bg-' + (isRunning ? 'success' : 'danger');
                    }

                    if (activePositionsElement && data) {
                        activePositionsElement.textContent = data.active_positions || 0;
                    }
                })
                .catch(error => {
                    console.error('Error updating bot status:', error.message || error.toString());
                    // Update UI to show error state
                    const statusElement = document.getElementById('botStatus');
                    if (statusElement) {
                        statusElement.textContent = 'ERROR';
                        statusElement.className = 'badge bg-warning';
                    }
                });

            // Update balance with better error handling
            fetch('/api/balance')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.balance !== undefined) {
                        const balanceElement = document.getElementById('balance');
                        if (balanceElement) {
                            balanceElement.textContent = data.balance.toFixed(2);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating balance:', error.message || error.toString());
                    // Update UI to show error state
                    const balanceElement = document.getElementById('balance');
                    if (balanceElement) {
                        balanceElement.textContent = 'ERROR';
                    }
                });
        }, 5000);

        // Fetch console log every 2 seconds
        setInterval(fetchConsoleLog, 2000);

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            updatePositionsTable();
            fetchConsoleLog();
            updateEnvironment();

            // Add environment toggle listener
            document.getElementById('environmentToggle').addEventListener('change', toggleEnvironment);
        });
    </script>
</body>
</html>