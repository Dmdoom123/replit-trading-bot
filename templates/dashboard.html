
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-robot"></i> Trading Bot Dashboard
            </span>
            <div class="d-flex">
                <span class="badge bg-{{ 'success' if status.running else 'danger' }} me-2">
                    {{ 'RUNNING' if status.running else 'STOPPED' }}
                </span>
                <button id="botToggle" class="btn btn-{{ 'danger' if status.running else 'success' }} btn-sm">
                    {{ 'Stop Bot' if status.running else 'Start Bot' }}
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Bot Status Card -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-info-circle"></i> Bot Status</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Status:</strong> <span id="botStatus" class="badge bg-{{ 'success' if status.running else 'danger' }}">{{ 'RUNNING' if status.running else 'STOPPED' }}</span></p>
                        <p><strong>Balance:</strong> $<span id="balance">{{ "%.2f"|format(balance) }}</span> USDT</p>
                        <p><strong>Active Positions:</strong> <span id="activePositions">{{ status.active_positions }}</span></p>
                        <p><strong>Active Strategies:</strong> {{ status.strategies|length }}</p>
                        <button class="btn btn-info btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100" onclick="showDefaultParamsModal()">
                                    <i class="fas fa-cog"></i><br>Default Settings
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100" onclick="showStrategyModal()">
                                    <i class="fas fa-chart-line"></i><br>Strategies
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100" onclick="window.open('/chart/BTCUSDT', '_blank')">
                                    <i class="fas fa-chart-area"></i><br>BTC Chart
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100" onclick="window.open('/chart/ETHUSDT', '_blank')">
                                    <i class="fas fa-chart-area"></i><br>ETH Chart
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">
                                <button class="btn btn-outline-purple w-100" onclick="window.open('/ml-reports', '_blank')" style="border-color: #6f42c1; color: #6f42c1;">
                                    <i class="fas fa-brain"></i><br>ML Reports
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-dark w-100" onclick="sendDailyReport()">
                                    <i class="fas fa-paper-plane"></i><br>Send Report
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="exportTradeData()">
                                    <i class="fas fa-download"></i><br>Export Data
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100" onclick="trainMLModels()">
                                    <i class="fas fa-cogs"></i><br>Train ML
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Positions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-coins"></i> Active Positions</h5>
                    </div>
                    <div class="card-body">
                        <div id="positionsTable">
                            {% if active_positions %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Symbol</th>
                                            <th>Side</th>
                                            <th>Entry Price</th>
                                            <th>Quantity</th>
                                            <th>Current Price</th>
                                            <th>PnL (USDT)</th>
                                            <th>PnL (%)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for position in active_positions %}
                                        <tr>
                                            <td>{{ position.strategy.upper() }}</td>
                                            <td>{{ position.symbol }}</td>
                                            <td><span class="badge bg-{{ 'success' if position.side == 'BUY' else 'danger' }}">{{ position.side }}</span></td>
                                            <td>${{ "%.4f"|format(position.entry_price) }}</td>
                                            <td>{{ "%.6f"|format(position.quantity) }}</td>
                                            <td>${{ "%.4f"|format(position.current_price) if position.current_price else 'N/A' }}</td>
                                            <td class="{{ 'text-success' if position.pnl > 0 else 'text-danger' }}">${{ "%.2f"|format(position.pnl) }}</td>
                                            <td class="{{ 'text-success' if position.pnl_percent > 0 else 'text-danger' }}">{{ "%.2f"|format(position.pnl_percent) }}%</td>
                                            <td>
                                                <button class="btn btn-info btn-sm" onclick="window.open('/chart/{{ position.symbol }}', '_blank')">
                                                    <i class="fas fa-chart-area"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">No active positions</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Configuration -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-cogs"></i> Strategy Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Margin (USDT)</th>
                                        <th>Leverage</th>
                                        <th>Timeframe</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for strategy_name, config in strategies.items() %}
                                    <tr>
                                        <td>{{ strategy_name.upper() }}</td>
                                        <td>{{ config.symbol }}</td>
                                        <td>${{ config.margin }}</td>
                                        <td>{{ config.leverage }}x</td>
                                        <td>{{ config.timeframe }}</td>
                                        <td>
                                            <button class="btn btn-warning btn-sm" onclick="editStrategy('{{ strategy_name }}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-info btn-sm" onclick="window.open('/chart/{{ config.symbol }}', '_blank')">
                                                <i class="fas fa-chart-area"></i> Chart
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Default Parameters Modal -->
    <div class="modal fade" id="defaultParamsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Default Trading Parameters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="defaultParamsForm">
                        <div class="mb-3">
                            <label class="form-label">Default Symbol</label>
                            <input type="text" class="form-control" id="defaultSymbol" placeholder="BTCUSDT">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Default Margin (USDT)</label>
                            <input type="number" class="form-control" id="defaultMargin" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Default Leverage</label>
                            <input type="number" class="form-control" id="defaultLeverage" min="1" max="20">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Default Timeframe</label>
                            <select class="form-control" id="defaultTimeframe">
                                <option value="1m">1 minute</option>
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="4h">4 hours</option>
                                <option value="1d">1 day</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDefaultParams()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Edit Modal -->
    <div class="modal fade" id="strategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyModalTitle">Edit Strategy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyForm">
                        <input type="hidden" id="editStrategyName">
                        <div class="mb-3">
                            <label class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="strategySymbol">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Margin (USDT)</label>
                            <input type="number" class="form-control" id="strategyMargin" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Leverage</label>
                            <input type="number" class="form-control" id="strategyLeverage" min="1" max="20">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Timeframe</label>
                            <select class="form-control" id="strategyTimeframe">
                                <option value="1m">1 minute</option>
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="4h">4 hours</option>
                                <option value="1d">1 day</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStrategy()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Bot control functions
        $('#botToggle').click(function() {
            const isRunning = $(this).text().includes('Stop');
            const endpoint = isRunning ? '/api/bot/stop' : '/api/bot/start';
            
            $.post(endpoint, function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        });

        // Refresh data
        function refreshData() {
            location.reload();
        }

        // Default parameters modal
        function showDefaultParamsModal() {
            $('#defaultParamsModal').modal('show');
        }

        function saveDefaultParams() {
            const data = {
                symbol: $('#defaultSymbol').val(),
                margin: parseFloat($('#defaultMargin').val()),
                leverage: parseInt($('#defaultLeverage').val()),
                timeframe: $('#defaultTimeframe').val()
            };

            $.ajax({
                url: '/api/default-params',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        $('#defaultParamsModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }

        // Strategy modal
        function showStrategyModal() {
            $('#strategyModal').modal('show');
        }

        function editStrategy(strategyName) {
            // Fetch current strategy config
            $.get('/api/strategies', function(data) {
                const strategy = data[strategyName];
                $('#editStrategyName').val(strategyName);
                $('#strategySymbol').val(strategy.symbol);
                $('#strategyMargin').val(strategy.margin);
                $('#strategyLeverage').val(strategy.leverage);
                $('#strategyTimeframe').val(strategy.timeframe);
                $('#strategyModalTitle').text('Edit ' + strategyName.toUpperCase());
                $('#strategyModal').modal('show');
            });
        }

        function saveStrategy() {
            const strategyName = $('#editStrategyName').val();
            const data = {
                symbol: $('#strategySymbol').val(),
                margin: parseFloat($('#strategyMargin').val()),
                leverage: parseInt($('#strategyLeverage').val()),
                timeframe: $('#strategyTimeframe').val()
            };

            $.ajax({
                url: '/api/strategies/' + strategyName,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        $('#strategyModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }

        // ML Functions
        function sendDailyReport() {
            if (confirm('Send daily report to Telegram?')) {
                $.post('/api/daily-report/send', function(data) {
                    if (data.success) {
                        alert('✅ Daily report sent successfully!');
                    } else {
                        alert('❌ Failed to send report: ' + (data.error || 'Unknown error'));
                    }
                });
            }
        }

        function exportTradeData() {
            $.get('/api/trade-data/export', function(data) {
                if (data.success) {
                    alert('✅ Trade data exported to: ' + data.filename);
                } else {
                    alert('❌ Failed to export data: ' + (data.error || 'Unknown error'));
                }
            });
        }

        function trainMLModels() {
            if (confirm('Train ML models? This may take a few minutes.')) {
                $.post('/api/ml/train', function(data) {
                    if (data.error) {
                        alert('❌ Training failed: ' + data.error);
                    } else {
                        let message = '✅ ML models trained successfully!\n\n';
                        if (data.profitability_accuracy) {
                            message += '📊 Profitability accuracy: ' + (data.profitability_accuracy * 100).toFixed(1) + '%\n';
                        }
                        if (data.pnl_r2_score) {
                            message += '📈 PnL R² score: ' + data.pnl_r2_score.toFixed(2) + '\n';
                        }
                        alert(message);
                    }
                });
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(function() {
            // Update positions table
            $.get('/api/positions', function(data) {
                // Update positions display
            });
            
            // Update bot status
            $.get('/api/bot/status', function(data) {
                $('#botStatus').text(data.running ? 'RUNNING' : 'STOPPED');
                $('#botStatus').removeClass('bg-success bg-danger').addClass(data.running ? 'bg-success' : 'bg-danger');
                $('#activePositions').text(data.active_positions);
            });
            
            // Update balance
            $.get('/api/balance', function(data) {
                if (data.balance !== undefined) {
                    $('#balance').text(data.balance.toFixed(2));
                }
            });
        }, 30000);
    </script>
</body>
</html>
