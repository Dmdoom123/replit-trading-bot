<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-robot"></i> Trading Bot Dashboard
            </span>
            <div class="d-flex">
                <span class="badge bg-{{ 'success' if status.running else 'danger' }} me-2">
                    {{ 'RUNNING' if status.running else 'STOPPED' }}
                </span>
                <button id="botToggle" class="btn btn-{{ 'danger' if status.running else 'success' }} btn-sm">
                    {{ 'Stop Bot' if status.running else 'Start Bot' }}
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Bot Status Card -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-info-circle"></i> Bot Status</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Status:</strong> <span id="botStatus" class="badge bg-{{ 'success' if status.running else 'danger' }}">{{ 'RUNNING' if status.running else 'STOPPED' }}</span></p>
                        <p><strong>Balance:</strong> $<span id="balance">{{ "%.2f"|format(balance) }}</span> USDT</p>
                        <p><strong>Active Positions:</strong> <span id="activePositions">{{ status.active_positions }}</span></p>
                        <p><strong>Active Strategies:</strong> {{ status.strategies|length }}</p>
                        <button class="btn btn-info btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100" onclick="showStrategiesInfo()">
                                    <i class="fas fa-cog"></i><br>View Strategies
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100" onclick="refreshData()">
                                    <i class="fas fa-chart-line"></i><br>Refresh Data
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100" onclick="clearConsoleLog()">
                                    <i class="fas fa-trash"></i><br>Clear Console
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-dark w-100" onclick="showConsoleInfo()">
                                    <i class="fas fa-terminal"></i><br>Console Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Positions and Console Log -->
        <div class="row mt-4">
            <!-- Active Positions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-coins"></i> Active Positions</h5>
                    </div>
                    <div class="card-body">
                        <div id="positionsTable">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Symbol</th>
                                            <th>Side</th>
                                            <th>Entry Price</th>
                                            <th>Position (USDT)</th>
                                            <th>Current Price</th>
                                            <th>PnL (USDT)</th>
                                            <th>PnL (%)</th>
                                            <th>Current RSI</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positionsTableBody">
                                        <tr>
                                            <td colspan="9" class="text-muted text-center">Loading positions...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Console Log -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-terminal"></i> Live Console Log</h5>
                        <div class="float-end">
                            <button class="btn btn-sm btn-outline-light" onclick="clearConsoleLog()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="toggleAutoScroll()" id="autoScrollBtn">
                                <i class="fas fa-arrows-alt-v"></i> Auto-scroll: ON
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="consoleLog" style="height: 400px; overflow-y: auto; background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px;">
                            <div class="text-muted">Waiting for console output...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Configuration -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-cogs"></i> Strategy Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Margin (USDT)</th>
                                        <th>Leverage</th>
                                        <th>Timeframe</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for strategy_name, config in strategies.items() %}
                                    <tr>
                                        <td>{{ strategy_name.upper() }}</td>
                                        <td>{{ config.symbol }}</td>
                                        <td>${{ config.margin }}</td>
                                        <td>{{ config.leverage }}x</td>
                                        <td>{{ config.timeframe }}</td>
                                        <td><span class="badge bg-success">Active</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for auto-scroll
        let autoScroll = true;
        let consoleLogBuffer = [];

        // Bot control functions
        document.getElementById('botToggle').addEventListener('click', function() {
            const isRunning = this.textContent.includes('Stop');
            const endpoint = isRunning ? '/api/bot/stop' : '/api/bot/start';

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Connection error');
            });
        });

        // Refresh data
        function refreshData() {
            location.reload();
        }

        // Show strategies info
        function showStrategiesInfo() {
            fetch('/api/strategies')
                .then(response => response.json())
                .then(data => {
                    let info = 'Current Strategies:\n\n';
                    for (const [name, config] of Object.entries(data)) {
                        info += name.toUpperCase() + ':\n';
                        info += '  Symbol: ' + config.symbol + '\n';
                        info += '  Margin: $' + config.margin + '\n';
                        info += '  Leverage: ' + config.leverage + 'x\n';
                        info += '  Timeframe: ' + config.timeframe + '\n\n';
                    }
                    alert(info);
                })
                .catch(error => {
                    alert('Error loading strategies: ' + error);
                });
        }

        // Show console info
        function showConsoleInfo() {
            alert('Console shows real-time bot activity:\n\n' +
                  '• Green messages: Successful operations\n' +
                  '• Red messages: Errors or warnings\n' +
                  '• Blue messages: Information\n' +
                  '• Yellow messages: Market analysis\n\n' +
                  'Auto-scroll keeps the latest messages visible.');
        }

        // Update positions table
        function updatePositionsTable() {
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.positions) {
                        updatePositionsDisplay(data.positions);
                    } else {
                        document.getElementById('positionsTableBody').innerHTML = 
                            '<tr><td colspan="9" class="text-muted text-center">No active positions</td></tr>';
                    }
                })
                .catch(error => {
                    document.getElementById('positionsTableBody').innerHTML = 
                        '<tr><td colspan="9" class="text-danger text-center">Failed to load positions</td></tr>';
                });
        }

        function updatePositionsDisplay(positions) {
            if (positions.length === 0) {
                document.getElementById('positionsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-muted text-center">No active positions</td></tr>';
                return;
            }

            let html = '';
            positions.forEach(function(position, index) {
                let pnlClass = position.pnl > 0 ? 'text-success' : 'text-danger';
                let sideClass = position.side === 'BUY' ? 'success' : 'danger';

                html += '<tr>';
                html += '<td>' + position.strategy.toUpperCase() + '</td>';
                html += '<td>' + position.symbol + '</td>';
                html += '<td><span class="badge bg-' + sideClass + '">' + position.side + '</span></td>';
                html += '<td>$' + position.entry_price.toFixed(4) + '</td>';
                html += '<td>$' + (position.position_value_usdt ? position.position_value_usdt.toFixed(2) : (position.entry_price * position.quantity).toFixed(2)) + '</td>';
                html += '<td>' + (position.current_price ? '$' + position.current_price.toFixed(4) : 'N/A') + '</td>';
                html += '<td class="' + pnlClass + '">$' + position.pnl.toFixed(2) + '</td>';
                html += '<td class="' + pnlClass + '">' + (position.pnl_percent > 0 ? '+' : '') + position.pnl_percent.toFixed(2) + '%</td>';
                html += '<td><span id="rsi-' + index + '" class="badge bg-secondary">Loading...</span></td>';
                html += '</tr>';
            });
            document.getElementById('positionsTableBody').innerHTML = html;

            // Fetch RSI for each position
            positions.forEach(function(position, index) {
                fetchRSI(position.symbol, index);
            });
        }

        function fetchRSI(symbol, index) {
            fetch('/api/rsi/' + symbol)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let rsiValue = data.rsi;
                        let rsiClass = 'bg-secondary';

                        // Color code RSI values
                        if (rsiValue <= 30) {
                            rsiClass = 'bg-success'; // Oversold - green
                        } else if (rsiValue >= 70) {
                            rsiClass = 'bg-danger'; // Overbought - red
                        } else if (rsiValue <= 40) {
                            rsiClass = 'bg-info'; // Low - blue
                        } else if (rsiValue >= 60) {
                            rsiClass = 'bg-warning'; // High - yellow
                        }

                        const rsiElement = document.getElementById('rsi-' + index);
                        if (rsiElement) {
                            rsiElement.className = 'badge ' + rsiClass;
                            rsiElement.textContent = 'RSI: ' + rsiValue;
                        }
                    } else {
                        const rsiElement = document.getElementById('rsi-' + index);
                        if (rsiElement) {
                            rsiElement.className = 'badge bg-danger';
                            rsiElement.textContent = 'Error';
                        }
                    }
                })
                .catch(error => {
                    const rsiElement = document.getElementById('rsi-' + index);
                    if (rsiElement) {
                        rsiElement.className = 'badge bg-danger';
                        rsiElement.textContent = 'N/A';
                    }
                });
        }

        // Console log functions
        function fetchConsoleLog() {
            fetch('/api/console-log')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.logs) {
                        updateConsoleLog(data.logs);
                    }
                })
                .catch(error => {
                    console.error('Error fetching console log:', error);
                });
        }

        function updateConsoleLog(logs) {
            const consoleElement = document.getElementById('consoleLog');

            // Add new logs to buffer
            logs.forEach(function(log) {
                if (!consoleLogBuffer.includes(log)) {
                    consoleLogBuffer.push(log);

                    // Create log element
                    const logElement = document.createElement('div');
                    logElement.style.marginBottom = '2px';
                    logElement.style.wordWrap = 'break-word';

                    // Color code different log types
                    if (log.includes('ERROR') || log.includes('❌')) {
                        logElement.style.color = '#ff6b6b';
                    } else if (log.includes('WARNING') || log.includes('⚠️')) {
                        logElement.style.color = '#feca57';
                    } else if (log.includes('SUCCESS') || log.includes('✅')) {
                        logElement.style.color = '#48dbfb';
                    } else if (log.includes('INFO') || log.includes('ℹ️')) {
                        logElement.style.color = '#0abde3';
                    } else {
                        logElement.style.color = '#ffffff';
                    }

                    logElement.textContent = log;
                    consoleElement.appendChild(logElement);
                }
            });

            // Limit buffer size
            if (consoleLogBuffer.length > 1000) {
                consoleLogBuffer = consoleLogBuffer.slice(-500);
                // Clear and rebuild console
                consoleElement.innerHTML = '';
                consoleLogBuffer.forEach(function(log) {
                    const logElement = document.createElement('div');
                    logElement.textContent = log;
                    consoleElement.appendChild(logElement);
                });
            }

            // Auto-scroll to bottom if enabled
            if (autoScroll) {
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
        }

        function clearConsoleLog() {
            document.getElementById('consoleLog').innerHTML = '<div class="text-muted">Console cleared...</div>';
            consoleLogBuffer = [];
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.innerHTML = '<i class="fas fa-arrows-alt-v"></i> Auto-scroll: ' + (autoScroll ? 'ON' : 'OFF');
            btn.className = autoScroll ? 'btn btn-sm btn-outline-light' : 'btn btn-sm btn-outline-secondary';
        }

        // Auto-refresh every 5 seconds for positions and every 2 seconds for console
        setInterval(function() {
            updatePositionsTable();

            // Update bot status
            fetch('/api/bot/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('botStatus');
                    const activePositionsElement = document.getElementById('activePositions');

                    if (statusElement) {
                        statusElement.textContent = data.running ? 'RUNNING' : 'STOPPED';
                        statusElement.className = 'badge bg-' + (data.running ? 'success' : 'danger');
                    }

                    if (activePositionsElement) {
                        activePositionsElement.textContent = data.active_positions;
                    }
                })
                .catch(error => {
                    console.error('Error updating bot status:', error);
                });

            // Update balance
            fetch('/api/balance')
                .then(response => response.json())
                .then(data => {
                    if (data.balance !== undefined) {
                        const balanceElement = document.getElementById('balance');
                        if (balanceElement) {
                            balanceElement.textContent = data.balance.toFixed(2);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating balance:', error);
                });
        }, 5000);

        // Fetch console log every 2 seconds
        setInterval(fetchConsoleLog, 2000);

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            updatePositionsTable();
            fetchConsoleLog();
        });
    </script>
</body>
</html>